<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Community Quote Database</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-gradient-to-br from-indigo-50 via-white to-purple-50">
    <div class="max-w-4xl mx-auto p-6">
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900 mb-2">Community Quotes</h1>
            <p class="text-gray-600">Share and discover inspiring quotes from Marcus!</p>
        </div>

        <div class="mb-6 flex justify-center space-x-3">
            <button id="toggleFormBtn" class="bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 transition shadow-lg">
                Add Quote
            </button>
            <button id="adminBtn" class="text-xs px-3 py-2 rounded-lg border border-gray-300 text-gray-600 hover:bg-gray-100 transition">
                Admin
            </button>
        </div>

        <div id="addForm" class="bg-white rounded-xl shadow-lg p-6 mb-6 border border-gray-200 hidden">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800">Submit a Quote</h2>
            <div id="errorMessage" class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-4 hidden">
                <span id="errorText"></span>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Your name</label>
                    <input id="usernameInput" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="Name or handle">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        Quote <span class="text-red-500">*</span>
                    </label>
                    <textarea id="quoteInput" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" rows="3" placeholder="Enter the quote..." required></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Context</label>
                    <textarea id="contextInput" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" rows="2" placeholder="Who said it? When? Where?"></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Origin (URL)</label>
                    <input type="url" id="originInput" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="https://example.com/source">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Extra Information</label>
                    <textarea id="extraInfoInput" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" rows="3" placeholder="Additional notes, analysis, or context..."></textarea>
                </div>

                <button id="submitBtn" class="w-full bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 transition font-medium">
                    Submit Quote
                </button>
            </div>
        </div>

        <div class="mb-6">
            <div class="relative">
                <input type="text" id="searchInput" placeholder="Search quotes..." class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent bg-white shadow-sm">
            </div>
        </div>

        <div id="loadingState" class="text-center py-12 text-gray-500">Loading quotes...</div>

        <div id="quotesList" class="space-y-4 hidden"></div>

        <div id="emptyState" class="text-center py-12 text-gray-500 hidden">
            No quotes yet. Be the first to add one!
        </div>

        <div class="mt-8 text-center text-sm text-gray-500">
            <p>All quotes are publicly visible and stored using shared storage.</p>
            <p class="mt-1">Inappropriate content will be rejected automatically.</p>
        </div>
    </div>

    <script>
        let quotes = [];
        let selectedQuoteId = null;
        let isAdmin = false;

        // Simple storage shim for GitHub Pages / plain browsers using localStorage
        (function initializeStorageShim() {
            if (window.storage) return;

            const STORAGE_PREFIX = 'quote-db:';

            window.storage = {
                async set(key, value) {
                    try {
                        localStorage.setItem(STORAGE_PREFIX + key, value);
                    } catch (e) {
                        console.error('Failed to write to localStorage', e);
                        throw e;
                    }
                },
                async get(key) {
                    const fullKey = STORAGE_PREFIX + key;
                    const value = localStorage.getItem(fullKey);
                    if (value === null || value === undefined) {
                        return null;
                    }
                    return { value: value };
                },
                async list(prefix) {
                    const effectivePrefix = STORAGE_PREFIX + (prefix || '');
                    const keys = [];
                    for (let i = 0; i < localStorage.length; i++) {
                        const k = localStorage.key(i);
                        if (k && k.startsWith(effectivePrefix)) {
                            // Strip storage prefix before returning
                            keys.push(k.substring(STORAGE_PREFIX.length));
                        }
                    }
                    return { keys: keys };
                }
            };
        })();

        document.addEventListener('DOMContentLoaded', function() {
            loadQuotes();
            setupEventListeners();
        });

        function setupEventListeners() {
            document.getElementById('toggleFormBtn').addEventListener('click', toggleForm);
            document.getElementById('submitBtn').addEventListener('click', handleSubmit);
            document.getElementById('searchInput').addEventListener('input', renderQuotes);
            document.getElementById('adminBtn').addEventListener('click', enterAdminMode);
        }

        function toggleForm() {
            var form = document.getElementById('addForm');
            var btn = document.getElementById('toggleFormBtn');
            
            if (form.classList.contains('hidden')) {
                form.classList.remove('hidden');
                btn.textContent = 'Cancel';
            } else {
                form.classList.add('hidden');
                btn.textContent = 'Add Quote';
                clearForm();
            }
        }

        function clearForm() {
            document.getElementById('usernameInput').value = '';
            document.getElementById('quoteInput').value = '';
            document.getElementById('contextInput').value = '';
            document.getElementById('originInput').value = '';
            document.getElementById('extraInfoInput').value = '';
            hideError();
        }

        function showError(message) {
            document.getElementById('errorText').textContent = message;
            document.getElementById('errorMessage').classList.remove('hidden');
        }

        function hideError() {
            document.getElementById('errorMessage').classList.add('hidden');
        }

        function normalizeForFiltering(text) {
            if (!text) return '';
            let t = text.toLowerCase();
            t = t.replace(/[\s._-]+/g, '');
            const map = {
                '1': 'i',
                '!': 'i',
                '3': 'e',
                '4': 'a',
                '@': 'a',
                '0': 'o',
                '5': 's',
                '7': 't'
            };
            t = t.replace(/[1!34@05t]/g, function(ch) {
                return map[ch] || ch;
            });
            return t;
        }

        function containsInappropriateContent(text) {
            if (!text) return false;

            const inappropriatePatterns = [
                /\b(fuck|shit|ass|bitch|damn|hell|crap|piss|cock|dick|pussy|cunt|bastard|whore|slut)\b/i,
                /\b(kill yourself|kys|suicide|die)\b/i,
                /\b(n[i1]gg[ae]r|f[a4]gg[o0]t|r[e3]t[a4]rd)\b/i,
                /(xxx|porn|sex|nude)/i
            ];

            const normalized = normalizeForFiltering(text);
            const normalizedPatterns = [
                /(fuck|shit|ass|bitch|crap|piss|cock|dick|pussy|cunt|bastard|whore|slut)/i,
                /(killyourself|kys|suicide|die)/i,
                /(nigger|faggot|retard)/i,
                /(xxx|porn|sex|nude)/i
            ];

            if (inappropriatePatterns.some(function(pattern) { return pattern.test(text); })) {
                return true;
            }

            return normalizedPatterns.some(function(pattern) {
                return pattern.test(normalized);
            });
        }

        function isValidUrl(string) {
            if (!string) return true;
            try {
                new URL(string);
                return true;
            } catch (e) {
                return false;
            }
        }

        async function handleSubmit() {
            hideError();
            
            var username = document.getElementById('usernameInput').value.trim();
            var quote = document.getElementById('quoteInput').value.trim();
            var context = document.getElementById('contextInput').value.trim();
            var origin = document.getElementById('originInput').value.trim();
            var extraInfo = document.getElementById('extraInfoInput').value.trim();

            if (!quote) {
                showError('Quote text is required');
                return;
            }

            var textToCheck = [username, quote, context, extraInfo].join(' ');
            if (containsInappropriateContent(textToCheck)) {
                showError('Your submission contains inappropriate content. Please revise and try again.');
                return;
            }

            if (origin && !isValidUrl(origin)) {
                showError('Please provide a valid URL for the origin');
                return;
            }

            if (username) {
                try {
                    localStorage.setItem('quote-db:username', username);
                } catch (e) {
                    console.warn('Failed to persist username', e);
                }
            }

            var newQuote = {
                id: 'quote:' + Date.now() + '-' + Math.random().toString(36).substr(2, 9),
                username: username,
                quote: quote,
                context: context,
                origin: origin,
                extraInfo: extraInfo,
                timestamp: Date.now()
            };

            try {
                await window.storage.set(newQuote.id, JSON.stringify(newQuote), true);
                quotes.unshift(newQuote);
                renderQuotes();
                clearForm();
                toggleForm();
            } catch (err) {
                showError('Failed to save quote. Please try again.');
            }
        }

        function renderQuotes() {
            var searchTerm = document.getElementById('searchInput').value.toLowerCase();
            var filteredQuotes = quotes.filter(function(q) {
                var quoteText = (q.quote || '').toLowerCase();
                var contextText = (q.context || '').toLowerCase();
                var userText = (q.username || '').toLowerCase();
                return quoteText.includes(searchTerm) ||
                       contextText.includes(searchTerm) ||
                       userText.includes(searchTerm);
            });

            var quotesList = document.getElementById('quotesList');
            var emptyState = document.getElementById('emptyState');

            if (filteredQuotes.length === 0) {
                quotesList.classList.add('hidden');
                emptyState.classList.remove('hidden');
                emptyState.textContent = searchTerm ? 'No quotes found matching your search.' : 'No quotes yet. Be the first to add one!';
                return;
            }

            emptyState.classList.add('hidden');
            quotesList.classList.remove('hidden');
            quotesList.innerHTML = '';

            filteredQuotes.forEach(function(q) {
                var quoteCard = document.createElement('div');
                quoteCard.className = 'bg-white rounded-xl shadow-md p-6 cursor-pointer hover:shadow-lg transition border border-gray-200';
                quoteCard.onclick = function() {
                    toggleQuoteDetails(q.id);
                };

                var isExpanded = selectedQuoteId === q.id;

                var html = '<div class="text-lg text-gray-800 font-medium mb-2">"' + escapeHtml(q.quote) + '"</div>';

                if (q.context) {
                    html += '<div class="text-sm text-gray-600 mb-1">â€” ' + escapeHtml(q.context) + '</div>';
                }

                if (q.username) {
                    html += '<div class="text-xs text-gray-500 mb-2">Added by ' + escapeHtml(q.username) + '</div>';
                }

                if (isExpanded) {
                    html += '<div class="mt-4 pt-4 border-t border-gray-200 space-y-3">';
                    
                    if (q.extraInfo) {
                        html += '<div><div class="text-xs font-semibold text-gray-500 uppercase mb-1">Extra Information</div>';
                        html += '<div class="text-sm text-gray-700">' + escapeHtml(q.extraInfo) + '</div></div>';
                    }
                    
                    if (q.origin) {
                        html += '<div><div class="text-xs font-semibold text-gray-500 uppercase mb-1">Origin</div>';
                        html += '<a href="' + escapeHtml(q.origin) + '" target="_blank" rel="noopener noreferrer" ';
                        html += 'class="text-sm text-indigo-600 hover:text-indigo-800" onclick="event.stopPropagation()">';
                        html += escapeHtml(q.origin) + '</a></div>';
                    }
                    
                    html += '</div>';
                }

                html += '<div class="text-xs text-gray-400 mt-3">' + new Date(q.timestamp).toLocaleDateString() + '</div>';

                quoteCard.innerHTML = html;

                if (isAdmin) {
                    var deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'Delete';
                    deleteBtn.className = 'mt-3 inline-flex items-center px-3 py-1 text-xs font-medium text-red-600 border border-red-200 rounded hover:bg-red-50';
                    deleteBtn.onclick = function(event) {
                        event.stopPropagation();
                        deleteQuote(q.id);
                    };
                    quoteCard.appendChild(deleteBtn);
                }

                quotesList.appendChild(quoteCard);
            });
        }

        function toggleQuoteDetails(id) {
            selectedQuoteId = selectedQuoteId === id ? null : id;
            renderQuotes();
        }

        function enterAdminMode() {
            var input = window.prompt('Enter admin passphrase:');
            if (input === null) {
                return;
            }
            if (input === 'marcus1shiru2bigbadinkybones') {
                isAdmin = true;
                renderQuotes();
            } else {
                alert('Incorrect passphrase.');
            }
        }

        async function deleteQuote(id) {
            if (!window.confirm('Delete this quote? This cannot be undone.')) {
                return;
            }
            try {
                if (typeof window.storage.remove === 'function') {
                    await window.storage.remove(id, true);
                } else {
                    const storageKey = id;
                    const STORAGE_PREFIX = 'quote-db:';
                    try {
                        localStorage.removeItem(STORAGE_PREFIX + storageKey);
                    } catch (e) {
                        console.error('Failed to remove from localStorage', e);
                    }
                }
            } catch (e) {
                console.error('Failed to delete quote from storage', e);
            }
            quotes = quotes.filter(function(q) { return q.id !== id; });
            renderQuotes();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
