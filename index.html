<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Marcus the Worm Database</title>
    <script>
        window.tailwind = window.tailwind || {};
        tailwind.config = {
            darkMode: 'class'
        };
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Global dark-mode effect: invert colors for a striking contrast */
        html.dark {
            filter: invert(1) hue-rotate(180deg);
        }

        /* Avoid inverting media twice if you add any later */
        html.dark img,
        html.dark video {
            filter: invert(1) hue-rotate(180deg);
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-rose-50 via-white to-indigo-50 dark:bg-gradient-to-br dark:from-slate-950 dark:via-slate-900 dark:to-slate-800 transition-colors">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <div class="mb-8 flex items-start justify-between gap-4">
            <div>
                <h1 class="text-4xl font-bold text-gray-900 dark:text-gray-50 mb-2">Marcus' Quotes</h1>
                <p class="text-gray-600 dark:text-gray-300">Share and discover inspiring quotes from Marcus!</p>
            </div>
            <button id="themeToggleBtn" class="inline-flex items-center px-3 py-2 text-xs font-medium rounded-full border border-indigo-100 bg-indigo-50 text-indigo-700 hover:bg-indigo-100 dark:border-slate-600 dark:bg-slate-800 dark:text-slate-100 dark:hover:bg-slate-700 transition">
                <span id="themeToggleLabel">Dark</span>
            </button>
        </div>
        <div id="corner1" class="fixed bottom-0 left-0 w-6 h-6 opacity-0 cursor-default select-none"></div>

        <div class="mb-6 flex justify-center space-x-3">
            <button id="toggleFormBtn" class="bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 transition shadow-lg dark:bg-indigo-500 dark:hover:bg-indigo-400">
                Add Quote
            </button>
        </div>

        <div id="addForm" class="bg-white dark:bg-slate-900 rounded-xl shadow-lg p-6 mb-6 border border-gray-200 dark:border-slate-700 hidden">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800 dark:text-gray-100">Submit a Quote</h2>
            <div id="errorMessage" class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-4 hidden dark:bg-red-900/40 dark:border-red-700 dark:text-red-100">
                <span id="errorText"></span>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1">Your name</label>
                    <input id="usernameInput" class="w-full px-4 py-2 border border-gray-300 dark:border-slate-700 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent bg-white dark:bg-slate-900 dark:text-gray-100" placeholder="Name or handle">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1">
                        Quote <span class="text-red-500">*</span>
                    </label>
                    <textarea id="quoteInput" class="w-full px-4 py-2 border border-gray-300 dark:border-slate-700 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent bg-white dark:bg-slate-900 dark:text-gray-100" rows="3" placeholder="Enter the quote..." required></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1">Context</label>
                    <textarea id="contextInput" class="w-full px-4 py-2 border border-gray-300 dark:border-slate-700 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent bg-white dark:bg-slate-900 dark:text-gray-100" rows="2" placeholder="Who said it? When? Where?"></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1">Origin (URL)</label>
                    <input type="url" id="originInput" class="w-full px-4 py-2 border border-gray-300 dark:border-slate-700 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent bg-white dark:bg-slate-900 dark:text-gray-100" placeholder="https://example.com/source">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1">Extra Information</label>
                    <textarea id="extraInfoInput" class="w-full px-4 py-2 border border-gray-300 dark:border-slate-700 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent bg-white dark:bg-slate-900 dark:text-gray-100" rows="3" placeholder="Additional notes, analysis, or context..."></textarea>
                </div>

                <button id="submitBtn" class="w-full bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 transition font-medium dark:bg-indigo-500 dark:hover:bg-indigo-400">
                    Submit Quote
                </button>
            </div>
        </div>

        <div class="mb-6 space-y-3">
            <div class="relative">
                <input type="text" id="searchInput" placeholder="Search quotes..." class="w-full px-4 py-3 border border-gray-300 dark:border-slate-700 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent bg-white dark:bg-slate-900 dark:text-gray-100 shadow-sm">
            </div>
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 text-sm text-gray-600 dark:text-gray-300">
                <div class="flex items-center space-x-2">
                    <label for="sortSelect" class="font-medium">Sort by</label>
                    <select id="sortSelect" class="px-2 py-1 border border-gray-300 dark:border-slate-700 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-transparent bg-white dark:bg-slate-900 dark:text-gray-100">
                        <option value="newest">Newest first</option>
                        <option value="oldest">Oldest first</option>
                    </select>
                </div>
                <div class="flex items-center justify-between gap-3 sm:justify-end">
                    <label class="inline-flex items-center space-x-2 cursor-pointer select-none">
                        <input id="myQuotesToggle" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                        <span class="text-xs sm:text-sm">My quotes only</span>
                    </label>
                    <button id="randomQuoteBtn" class="px-3 py-1 rounded-md bg-indigo-50 text-indigo-700 hover:bg-indigo-100 border border-indigo-100 dark:bg-slate-800 dark:text-indigo-200 dark:border-slate-600 dark:hover:bg-slate-700">
                        Random quote
                    </button>
                </div>
            </div>
        </div>

        <div id="loadingState" class="text-center py-12 text-gray-500 dark:text-gray-400">Loading quotes...</div>

        <div id="quotesList" class="space-y-4 hidden"></div>

        <div id="emptyState" class="text-center py-12 text-gray-500 dark:text-gray-400 hidden">
            No quotes yet. Be the first to add one!
        </div>

        <div class="mt-8 text-center text-sm text-gray-500 dark:text-gray-400">
            <p>All quotes are publicly visible and stored using shared storage.</p>
            <p class="mt-1">Inappropriate content will be rejected automatically.</p>
        </div>
    </div>

    <script>
        let quotes = [];
        let selectedQuoteId = null;
        let isAdmin = false;
        let currentSort = 'newest';
        let currentTheme = 'light';
        let currentUsername = '';
        let myQuotesOnly = false;

        // Simple storage shim for GitHub Pages / plain browsers using localStorage
        (function initializeStorageShim() {
            if (window.storage) return;

            const STORAGE_PREFIX = 'quote-db:';

            window.storage = {
                async set(key, value) {
                    try {
                        localStorage.setItem(STORAGE_PREFIX + key, value);
                    } catch (e) {
                        console.error('Failed to write to localStorage', e);
                        throw e;
                    }
                },
                async get(key) {
                    const fullKey = STORAGE_PREFIX + key;
                    const value = localStorage.getItem(fullKey);
                    if (value === null || value === undefined) {
                        return null;
                    }
                    return { value: value };
                },
                async list(prefix) {
                    const effectivePrefix = STORAGE_PREFIX + (prefix || '');
                    const keys = [];
                    for (let i = 0; i < localStorage.length; i++) {
                        const k = localStorage.key(i);
                        if (k && k.startsWith(effectivePrefix)) {
                            // Strip storage prefix before returning
                            keys.push(k.substring(STORAGE_PREFIX.length));
                        }
                    }
                    return { keys: keys };
                }
            };
        })();

        document.addEventListener('DOMContentLoaded', function() {
            try {
                // Restore saved username
                var savedUsername = null;
                try {
                    savedUsername = localStorage.getItem('quote-db:username');
                } catch (e) {
                    console.warn('Could not read saved username', e);
                }
                if (savedUsername) {
                    var usernameInput = document.getElementById('usernameInput');
                    if (usernameInput) {
                        usernameInput.value = savedUsername;
                    }
                    currentUsername = savedUsername;
                }

                // Restore theme preference
                var savedTheme = null;
                try {
                    savedTheme = localStorage.getItem('quote-db:theme');
                } catch (e) {
                    console.warn('Could not read saved theme', e);
                }
                if (savedTheme === 'dark' || savedTheme === 'light') {
                    applyTheme(savedTheme);
                } else {
                    applyTheme('light');
                }
            } catch (e) {
                console.error('Error during initial restore', e);
            }

            loadQuotes();
            setupEventListeners();
        });

        function setupEventListeners() {
            document.getElementById('toggleFormBtn').addEventListener('click', toggleForm);

            document.getElementById('submitBtn').addEventListener('click', handleSubmit);
            document.getElementById('searchInput').addEventListener('input', renderQuotes);
            document.getElementById('sortSelect').addEventListener('change', function(e) {
                currentSort = e.target.value === 'oldest' ? 'oldest' : 'newest';
                renderQuotes();
            });
            document.getElementById('randomQuoteBtn').addEventListener('click', scrollToRandomQuote);
            var myQuotesToggle = document.getElementById('myQuotesToggle');
            if (myQuotesToggle) {
                myQuotesToggle.addEventListener('change', function(e) {
                    myQuotesOnly = e.target.checked;
                    renderQuotes();
                });
            }

            var themeBtn = document.getElementById('themeToggleBtn');
            if (themeBtn) {
                themeBtn.addEventListener('click', toggleTheme);
            }

            var corner1 = document.getElementById('corner1');
            if (corner1) {
                corner1.addEventListener('click', enterAdminMode);
            }
        }

        function applyTheme(theme) {
            currentTheme = theme === 'dark' ? 'dark' : 'light';
            var root = document.documentElement;
            if (currentTheme === 'dark') {
                root.classList.add('dark');
            } else {
                root.classList.remove('dark');
            }
            try {
                localStorage.setItem('quote-db:theme', currentTheme);
            } catch (e) {}
            var label = document.getElementById('themeToggleLabel');
            if (label) {
                label.textContent = currentTheme === 'dark' ? 'Light' : 'Dark';
            }
        }

        function toggleTheme() {
            applyTheme(currentTheme === 'dark' ? 'light' : 'dark');
        }

        function toggleForm() {
            var form = document.getElementById('addForm');
            var btn = document.getElementById('toggleFormBtn');
            
            if (form.classList.contains('hidden')) {
                form.classList.remove('hidden');
                btn.textContent = 'Cancel';
            } else {
                form.classList.add('hidden');
                btn.textContent = 'Add Quote';
                clearForm();
            }
        }

        function clearForm() {
            var quoteInput = document.getElementById('quoteInput');
            var contextInput = document.getElementById('contextInput');
            var originInput = document.getElementById('originInput');
            var extraInfoInput = document.getElementById('extraInfoInput');

            if (quoteInput) quoteInput.value = '';
            if (contextInput) contextInput.value = '';
            if (originInput) originInput.value = '';
            if (extraInfoInput) extraInfoInput.value = '';

            hideError();
        }

        function showError(message) {
            document.getElementById('errorText').textContent = message;
            document.getElementById('errorMessage').classList.remove('hidden');
        }

        function hideError() {
            document.getElementById('errorMessage').classList.add('hidden');
        }

        function normalizeForFiltering(text) {
            if (!text) return '';
            let t = text.toLowerCase();
            t = t.replace(/[\s._-]+/g, '');
            const map = {
                '1': 'i',
                '!': 'i',
                '3': 'e',
                '4': 'a',
                '@': 'a',
                '0': 'o',
                '5': 's',
                '7': 't'
            };
            t = t.replace(/[1!34@05t]/g, function(ch) {
                return map[ch] || ch;
            });
            return t;
        }

        function containsInappropriateContent(text) {
            if (!text) return false;

            const inappropriatePatterns = [
                /\b(shit|ass|crap|piss|cock|dick|cunt|bastard|whore|slut)\b/i,
                /\b(kill yourself|kys|suicide|die)\b/i,
                /\b(n[i1]gg[ae]r|f[a4]gg[o0]t|r[e3]t[a4]rd)\b/i,
                /(xxx|porn|sex|nude)/i
            ];

            const normalized = normalizeForFiltering(text);
            const normalizedPatterns = [
                /(shit|ass|crap|piss|cock|dick|cunt|bastard|whore|slut)/i,
                /(killyourself|kys|suicide|die)/i,
                /(nigger|faggot|retard)/i,
                /(xxx|porn|sex|nude)/i
            ];

            if (inappropriatePatterns.some(function(pattern) { return pattern.test(text); })) {
                return true;
            }

            return normalizedPatterns.some(function(pattern) {
                return pattern.test(normalized);
            });
        }

        function isValidUrl(string) {
            if (!string) return true;
            try {
                new URL(string);
                return true;
            } catch (e) {
                return false;
            }
        }

        async function handleSubmit() {
            hideError();
            
            var username = document.getElementById('usernameInput').value.trim();
            var quote = document.getElementById('quoteInput').value.trim();
            var context = document.getElementById('contextInput').value.trim();
            var origin = document.getElementById('originInput').value.trim();
            var extraInfo = document.getElementById('extraInfoInput').value.trim();

            if (!quote) {
                showError('Quote text is required');
                return;
            }

            var textToCheck = [username, quote, context, extraInfo].join(' ');
            if (containsInappropriateContent(textToCheck)) {
                showError('Your submission contains inappropriate content. Please revise and try again.');
                return;
            }

            if (origin && !isValidUrl(origin)) {
                showError('Please provide a valid URL for the origin');
                return;
            }

            if (username) {
                try {
                    localStorage.setItem('quote-db:username', username);
                } catch (e) {
                    console.warn('Failed to persist username', e);
                }
                currentUsername = username;
            }

            var newQuote = {
                id: 'quote:' + Date.now() + '-' + Math.random().toString(36).substr(2, 9),
                username: username,
                quote: quote,
                context: context,
                origin: origin,
                extraInfo: extraInfo,
                timestamp: Date.now()
            };

            try {
                await window.storage.set(newQuote.id, JSON.stringify(newQuote), true);
                quotes.unshift(newQuote);
                renderQuotes();
                clearForm();
                toggleForm();
            } catch (err) {
                showError('Failed to save quote. Please try again.');
            }
        }

        async function loadQuotes() {
            try {
                var loadingEl = document.getElementById('loadingState');
                if (loadingEl) {
                    loadingEl.classList.remove('hidden');
                }

                var keys = await window.storage.list('quote:', true);

                if (keys && keys.keys) {
                    var loadedQuotes = [];
                    for (var i = 0; i < keys.keys.length; i++) {
                        var key = keys.keys[i];
                        try {
                            var result = await window.storage.get(key, true);
                            if (result && result.value) {
                                loadedQuotes.push(JSON.parse(result.value));
                            }
                        } catch (err) {
                            console.log('Quote not found:', key);
                        }
                    }
                    quotes = loadedQuotes.sort(function(a, b) {
                        return b.timestamp - a.timestamp;
                    });
                }
            } catch (err) {
                console.error('Error loading quotes:', err);
            } finally {
                var loadingElFinal = document.getElementById('loadingState');
                if (loadingElFinal) {
                    loadingElFinal.classList.add('hidden');
                }
                renderQuotes();
            }
        }

        function renderQuotes() {
            var searchTerm = document.getElementById('searchInput').value.toLowerCase();
            var filteredQuotes = quotes.filter(function(q) {
                var quoteText = (q.quote || '').toLowerCase();
                var contextText = (q.context || '').toLowerCase();
                var userText = (q.username || '').toLowerCase();
                return quoteText.includes(searchTerm) ||
                       contextText.includes(searchTerm) ||
                       userText.includes(searchTerm);
            });

            if (myQuotesOnly && currentUsername) {
                var me = currentUsername.toLowerCase();
                filteredQuotes = filteredQuotes.filter(function(q) {
                    return (q.username || '').toLowerCase() === me;
                });
            }

            var sortedQuotes = filteredQuotes.slice().sort(function(a, b) {
                if (currentSort === 'oldest') {
                    return a.timestamp - b.timestamp;
                }
                return b.timestamp - a.timestamp;
            });

            var quotesList = document.getElementById('quotesList');
            var emptyState = document.getElementById('emptyState');

            if (sortedQuotes.length === 0) {
                quotesList.classList.add('hidden');
                emptyState.classList.remove('hidden');
                emptyState.textContent = searchTerm ? 'No quotes found matching your search.' : 'No quotes yet. Be the first to add one!';
                return;
            }

            emptyState.classList.add('hidden');
            quotesList.classList.remove('hidden');
            quotesList.innerHTML = '';

            sortedQuotes.forEach(function(q) {
                var quoteCard = document.createElement('div');
                quoteCard.className = 'quote-card bg-white rounded-xl shadow-md p-6 cursor-pointer hover:shadow-xl transition border border-gray-200/80 shadow-gray-100 dark:shadow-black/40 dark:border-slate-700';

                quoteCard.id = 'quote-' + q.id;
                quoteCard.onclick = function() {
                    toggleQuoteDetails(q.id);
                };

                var isExpanded = selectedQuoteId === q.id;

                var html = '<div class="text-lg text-gray-800 dark:text-gray-50 font-semibold mb-2 italic">"' + escapeHtml(q.quote) + '"</div>';

                if (q.context) {
                    html += '<div class="text-sm text-gray-600 dark:text-gray-300 mb-1">â€” ' + escapeHtml(q.context) + '</div>';
                }

                if (q.username) {
                    html += '<div class="text-xs text-gray-500 dark:text-gray-400 mb-2">Added by ' + escapeHtml(q.username) + '</div>';
                }

                if (isExpanded) {
                    html += '<div class="mt-4 pt-4 border-t border-gray-200 space-y-3">';
                    
                    if (q.extraInfo) {
                        html += '<div><div class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase mb-1">Extra Information</div>';
                        html += '<div class="text-sm text-gray-700 dark:text-gray-200">' + escapeHtml(q.extraInfo) + '</div></div>';
                    }
                    
                    if (q.origin) {
                        html += '<div><div class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase mb-1">Origin</div>';
                        html += '<a href="' + escapeHtml(q.origin) + '" target="_blank" rel="noopener noreferrer" ';
                        html += 'class="text-sm text-indigo-600 hover:text-indigo-800 dark:text-indigo-300 dark:hover:text-indigo-200" onclick="event.stopPropagation()">';
                        html += escapeHtml(q.origin) + '</a></div>';
                    }
                    
                    html += '</div>';
                }

                html += '<div class="text-xs text-gray-400 dark:text-gray-500 mt-3">' + new Date(q.timestamp).toLocaleDateString() + '</div>';

                quoteCard.innerHTML = html;

                if (isAdmin) {
                    var deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'Delete';
                    deleteBtn.className = 'mt-3 inline-flex items-center px-3 py-1 text-xs font-medium text-red-600 border border-red-200 rounded hover:bg-red-50';
                    deleteBtn.onclick = function(event) {
                        event.stopPropagation();
                        deleteQuote(q.id);
                    };
                    quoteCard.appendChild(deleteBtn);
                }

                quotesList.appendChild(quoteCard);
            });
        }

        function toggleQuoteDetails(id) {
            selectedQuoteId = selectedQuoteId === id ? null : id;
            renderQuotes();
        }

        function scrollToRandomQuote() {
            if (!quotes || quotes.length === 0) {
                return;
            }
            var randomIndex = Math.floor(Math.random() * quotes.length);
            var target = quotes[randomIndex];
            if (!target) return;

            selectedQuoteId = target.id;
            renderQuotes();

            setTimeout(function() {
                var el = document.getElementById('quote-' + target.id);
                if (el) {
                    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 0);
        }

        function enterAdminMode() {
            var input = window.prompt('Enter admin passphrase:');
            if (input === null) {
                return;
            }
            if (input === 'marcus1shiru2bigbadinkybones') {
                isAdmin = true;
                renderQuotes();
            } else {
                alert('Incorrect passphrase.');
            }
        }

        async function deleteQuote(id) {
            if (!window.confirm('Delete this quote? This cannot be undone.')) {
                return;
            }
            try {
                if (typeof window.storage.remove === 'function') {
                    await window.storage.remove(id, true);
                } else {
                    const storageKey = id;
                    const STORAGE_PREFIX = 'quote-db:';
                    try {
                        localStorage.removeItem(STORAGE_PREFIX + storageKey);
                    } catch (e) {
                        console.error('Failed to remove from localStorage', e);
                    }
                }
            } catch (e) {
                console.error('Failed to delete quote from storage', e);
            }
            quotes = quotes.filter(function(q) { return q.id !== id; });
            renderQuotes();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
